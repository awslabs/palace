# Manages the 'no-nightly' label behavior for PRs.
#
# When 'no-nightly' label is added sets the nightly-tests status to success,
# which allows PR to be merged without waiting for nightly tests
#
# When 'no-nightly' label is removed sets the nightly-tests status to pending so
# that the PR will need to wait for next nightly run or manual trigger.

name: Nightly Label Handler

on:
  pull_request:
    types: [labeled, unlabeled]

permissions:
  statuses: write
  pull-requests: read

jobs:
  # Handle adding/removing 'no-nightly' label
  handle-no-nightly:
    if: contains(github.event.label.name, 'no-nightly')
    runs-on: ubuntu-latest
    steps:
      # When label is added: bypass nightly requirement
      - name: Set bypass status
        if: github.event.action == 'labeled'
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --method POST \
            --field state=success \
            --field context=nightly-tests \
            --field description="Nightly tests bypassed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # When label is removed: require nightly testing again
      - name: Remove bypass status
        if: github.event.action == 'unlabeled'
        run: |
          gh api repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --method POST \
            --field state=pending \
            --field context=nightly-tests \
            --field description="Waiting for nightly tests"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
