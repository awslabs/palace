<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Working with Spack · Palace</title><meta name="title" content="Working with Spack · Palace"/><meta property="og:title" content="Working with Spack · Palace"/><meta property="twitter:title" content="Working with Spack · Palace"/><meta name="description" content="Documentation for Palace."/><meta property="og:description" content="Documentation for Palace."/><meta property="twitter:description" content="Documentation for Palace."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.png" alt="Palace logo"/><img class="docs-dark-only" src="../../assets/logo-dark.png" alt="Palace logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../quick/">Quick Start</a></li><li><a class="tocitem" href="../../install/">Installation</a></li><li><a class="tocitem" href="../../run/">Running <em>Palace</em></a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../guide/guide/">Overview</a></li><li><a class="tocitem" href="../../guide/problem/">Problem Types</a></li><li><a class="tocitem" href="../../guide/model/">Simulation Models</a></li><li><a class="tocitem" href="../../guide/boundaries/">Boundary Conditions</a></li><li><a class="tocitem" href="../../guide/postprocessing/">Postprocessing and Visualization</a></li><li><a class="tocitem" href="../../guide/parallelism/">Parallelism and GPU Support</a></li></ul></li><li><span class="tocitem">Configuration File</span><ul><li><a class="tocitem" href="../../config/config/">Overview</a></li><li><a class="tocitem" href="../../config/problem/"><code>config[&quot;Problem&quot;]</code></a></li><li><a class="tocitem" href="../../config/model/"><code>config[&quot;Model&quot;]</code></a></li><li><a class="tocitem" href="../../config/domains/"><code>config[&quot;Domains&quot;]</code></a></li><li><a class="tocitem" href="../../config/boundaries/"><code>config[&quot;Boundaries&quot;]</code></a></li><li><a class="tocitem" href="../../config/solver/"><code>config[&quot;Solver&quot;]</code></a></li></ul></li><li><span class="tocitem">Features</span><ul><li><a class="tocitem" href="../../features/farfield/">Extracting Fields in the Radiation Zone</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Overview</a></li><li><a class="tocitem" href="../../examples/spheres/">Capacitance Matrix for Two Spheres</a></li><li><a class="tocitem" href="../../examples/rings/">Inductance Matrix for a Pair of Concentric Rings</a></li><li><a class="tocitem" href="../../examples/antenna/">Dipole Antenna and Radiation Fields</a></li><li><a class="tocitem" href="../../examples/transmon/">Single transmon with read-out resonator from <code>DeviceLayout.jl</code></a></li><li><a class="tocitem" href="../../examples/cylinder/">Eigenmodes of a Cylinder</a></li><li><a class="tocitem" href="../../examples/coaxial/">Signal Propagation in a Coaxial Cable</a></li><li><a class="tocitem" href="../../examples/cpw/">Crosstalk Between Coplanar Waveguides</a></li></ul></li><li><a class="tocitem" href="../../faq/">Frequently Asked Questions</a></li><li><span class="tocitem">For Developers</span><ul><li><a class="tocitem" href="../notes/">Developer Notes</a></li><li><a class="tocitem" href="../testing/">Testing</a></li><li class="is-active"><a class="tocitem" href>Working with Spack</a><ul class="internal"><li><a class="tocitem" href="#Developing-Palace-with-Spack-Environments"><span>Developing Palace with Spack Environments</span></a></li><li><a class="tocitem" href="#Developing-Palace&#39;s-Package-Recipe"><span>Developing Palace&#39;s Package Recipe</span></a></li><li><a class="tocitem" href="#Iterating-on-Package-Changes"><span>Iterating on Package Changes</span></a></li></ul></li><li><a class="tocitem" href="../tutorial_add_new_unit_test/">Tutorial: Adding a New Unit Test</a></li><li><a class="tocitem" href="../tutorial_gpu_profiling/">Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX</a></li></ul></li><li><a class="tocitem" href="../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">For Developers</a></li><li class="is-active"><a href>Working with Spack</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Working with Spack</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/awslabs/palace" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/awslabs/palace/blob/main/docs/src/developer/spack.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><!---
Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
SPDX-License-Identifier: Apache-2.0
---><h1 id="Working-with-Spack"><a class="docs-heading-anchor" href="#Working-with-Spack">Working with Spack</a><a id="Working-with-Spack-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-Spack" title="Permalink"></a></h1><p><a href="https://spack.io/">Spack</a> is a multi-platform package manager designed to handle the complexity of building scientific software with multiple versions, configurations, and dependencies. While Spack is commonly used to install <em>Palace</em> as an end user would, it&#39;s also a powerful tool for active development. One of the main reasons you might consider doing so is that Spack makes co-development of multiple packages straightforward, e.g., allowing you to point to local copies of both <em>Palace</em> and MFEM simultaneously. This guide walks you through both using Spack to develop <em>Palace</em> itself and working on <em>Palace</em>&#39;s Spack package recipe.</p><p>Before diving in, this guide assumes you already have Spack installed and understand the basics of how it works. If you&#39;re completely new to Spack, you should start with their official documentation to get familiar with concepts like specs, variants, and environments. Check the <a href="https://spack-tutorial.readthedocs.io/en/latest/index.html">official tutorials</a> out to get started.</p><h2 id="Developing-Palace-with-Spack-Environments"><a class="docs-heading-anchor" href="#Developing-Palace-with-Spack-Environments">Developing Palace with Spack Environments</a><a id="Developing-Palace-with-Spack-Environments-1"></a><a class="docs-heading-anchor-permalink" href="#Developing-Palace-with-Spack-Environments" title="Permalink"></a></h2><p>The recommended approach for developing <em>Palace</em> with Spack is to use Spack environments. An environment is essentially a self-contained workspace defined by a <code>spack.yaml</code> file that specifies exactly what you want to build and how you want to build it. This keeps your development setup isolated and reproducible.</p><p>To get started, create a dedicated directory for your environment. You might call it something like <code>palace_spack</code> or <code>palace_dev</code>. Inside this directory, create a <code>spack.yaml</code> file with the following content:</p><pre><code class="language-yaml hljs">spack:
  specs:
  - palace@develop
  develop:
    palace:
      spec: palace@=develop
      path: ~/repos/palace</code></pre><p>The <code>path</code> field should point to wherever you&#39;ve cloned the <em>Palace</em> repository on your system. The <code>specs</code> section defines what you want to install, and you can customize this with variants. For instance, if you need the test suite built, you would change the spec to <code>palace@develop+tests</code>. Spack&#39;s variant system is quite flexible, so you can enable or disable features as needed for your development work.</p><p>Before running the installation, it&#39;s sometimes worth taking advantage of packages that are already installed on your system. Spack calls these &quot;external packages,&quot; and finding them can significantly speed up your build times. You can scan for them by running:</p><pre><code class="language-sh hljs">spack -e palace_spack external find --all</code></pre><p>This command will modify your <code>spack.yaml</code> file to include references to system packages like compilers, MPI implementations, and common libraries. Spack will then use these instead of building them from scratch, which can save hours on the first build.</p><div class="admonition is-info" id="Risks-of-using-externals-13b0f7cb826402b0"><header class="admonition-header">Risks of using externals<a class="admonition-anchor" href="#Risks-of-using-externals-13b0f7cb826402b0" title="Permalink"></a></header><div class="admonition-body"><p>While using external packages can save hours of compilation time, Spack does not always handle them correctly, and incompatibilities are possible. If you find issues, you can try removing the external packages and letting Spack compile everythin.</p></div></div><p>Now you&#39;re ready to install <em>Palace</em> by running:</p><pre><code class="language-sh hljs">spack -e palace_spack install </code></pre><p>Be prepared for this first installation to take some time, potentially a few hours depending on your system and what needs to be built. Spack is building not just <em>Palace</em> but all of its dependencies from source. Spack caches everything it builds, so subsequent installations will be much faster. Even if you change variants or make other modifications to your environment, Spack is smart enough to only rebuild what&#39;s actually affected by your changes.</p><p>Once the installation completes, you can activate the environment and load <em>Palace</em> into your shell:</p><pre><code class="language-sh hljs">spack env activate palace_spack
spack load palace</code></pre><p>After this, the <code>palace</code> command will be available in your terminal. Whenever you make changes to the <em>Palace</em> source code, you can rebuild by simply running <code>spack install</code> again from within the environment. Spack will detect what&#39;s changed and recompile only what&#39;s necessary.</p><p>The beauty of this development mode is that it extends to other packages as well. If you need to modify MFEM alongside <em>Palace</em>, you can add another entry to the <code>develop</code> section of your <code>spack.yaml</code> pointing to your local MFEM checkout. Spack will then manage both packages in development mode, rebuilding each as needed when you make changes.</p><h2 id="Developing-Palace&#39;s-Package-Recipe"><a class="docs-heading-anchor" href="#Developing-Palace&#39;s-Package-Recipe">Developing Palace&#39;s Package Recipe</a><a id="Developing-Palace&#39;s-Package-Recipe-1"></a><a class="docs-heading-anchor-permalink" href="#Developing-Palace&#39;s-Package-Recipe" title="Permalink"></a></h2><p>Beyond developing <em>Palace</em> itself, you might need to work on <em>Palace</em>&#39;s Spack package recipe (the <code>package.py</code> file that tells Spack how to build <em>Palace</em>). This is particularly relevant if you&#39;re adding new dependencies, changing build options, or preparing a new release.</p><p>The first step is to add <em>Palace</em>&#39;s Spack repository to your Spack configuration. Assuming your <em>Palace</em> checkout is in <code>~/repos/palace</code>, you would run:</p><pre><code class="language-sh hljs">spack repo add ~/repos/palace/spack_repo/local</code></pre><p>You should see a confirmation message like <code>==&gt; Added repo with namespace &#39;local&#39;.</code> The namespace <code>local</code> is significant because it allows you to distinguish between your development version of the package and the official one in Spack&#39;s built-in repository. When you refer to <code>local.palace</code>, you&#39;re explicitly using the recipe from your personal repository, while <code>builtin.palace</code> refers to the official recipe that ships with Spack.</p><p>To verify that everything is working, try making a small change to the package file. For example, you could edit <code>spack_repo/local/packages/palace/package.py</code> and change the docstring to all capital letters. Then run:</p><pre><code class="language-sh hljs">spack info local.palace | head -n 4</code></pre><p>You should see your modified docstring. Compare this with the output of <code>spack info builtin.palace | head -n 4</code> to see the difference between your local version and the official one.</p><p>A shortcut to end the <code>package.py</code> is calling <code>spack edit local.palace</code>, which will open the file with your <code>$EDITOR</code>.</p><p>One important detail is that the <code>local</code> repository takes priority over <code>builtin</code>. This means that if you just run <code>spack info palace</code> without a prefix, Spack will use your local version. While this is convenient, we&#39;ll continue using the explicit <code>local.</code> prefix in examples for clarity.</p><h4 id="Working-Around-a-Spack-Bug-with-Patches"><a class="docs-heading-anchor" href="#Working-Around-a-Spack-Bug-with-Patches">Working Around a Spack Bug with Patches</a><a id="Working-Around-a-Spack-Bug-with-Patches-1"></a><a class="docs-heading-anchor-permalink" href="#Working-Around-a-Spack-Bug-with-Patches" title="Permalink"></a></h4><p>There&#39;s currently a known issue in Spack version &lt;=1.2.0 that affects packages using patches when they come from non-builtin repositories (see the <a href="https://github.com/spack/spack/issues/51505">bug report</a>). Since <em>Palace</em> uses patches, you&#39;ll run into this problem. The workaround is straightforward but a bit inelegant: you need to add a copy of the MFEM package to your local repository as well.</p><p>Rather than maintaining a duplicate copy of the MFEM recipe, you can create a symbolic link from Spack&#39;s built-in MFEM package to your local repository:</p><pre><code class="language-sh hljs">ln -s &quot;$(spack location --repo builtin)&quot;/packages/mfem ~/repos/palace/spack_repo/local/packages/</code></pre><p>This command uses Spack&#39;s <code>location</code> subcommand to find where the built-in repository lives, then creates a symlink to the MFEM package directory. To verify that the symlink was created correctly, run:</p><pre><code class="language-sh hljs">spack info local.mfem | head -n 4</code></pre><p>If you see MFEM&#39;s package information, you&#39;re all set. This workaround ensures that when Spack processes patches for <em>Palace</em>, it can find MFEM in the same repository namespace and avoid the bug.</p><h2 id="Iterating-on-Package-Changes"><a class="docs-heading-anchor" href="#Iterating-on-Package-Changes">Iterating on Package Changes</a><a id="Iterating-on-Package-Changes-1"></a><a class="docs-heading-anchor-permalink" href="#Iterating-on-Package-Changes" title="Permalink"></a></h2><p>With your local repository configured, you can now iterate on <em>Palace</em>&#39;s <code>package.py</code> file. After making changes, you can test them by installing <em>Palace</em> again. You can also use <code>spack spec local.palace@develop</code> to see how Spack would resolve dependencies without actually building anything, which is useful for catching errors early.</p><h3 id="Working-with-source-code-patches"><a class="docs-heading-anchor" href="#Working-with-source-code-patches">Working with source code patches</a><a id="Working-with-source-code-patches-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-source-code-patches" title="Permalink"></a></h3><p><em>Palace</em> requires some patches in some of the dependencies (primarily MFEM). Spack handles this, but there are a few common pitfalls.</p><p>First, patches are evaluated at concretization. This is because patches are embedded in the hash, which is computed at concretization. If you are iterating on patches, make sure to re-concretize your environment.</p><p>Second, <em>Palace</em> depends on a specific commit of MFEM (defined in the <code>package.py</code> or in the <code>ExternalGitTags.cmake</code>). <code>spack develop mfem</code> does not respect this commit restriction. In most cases, this means that you have to manually git checkout the specific hash for mfem in the mfem folder so that patches apply cleanly.</p><h3 id="Working-with-patches-for-package.py-files"><a class="docs-heading-anchor" href="#Working-with-patches-for-package.py-files">Working with patches for <code>package.py</code> files</a><a id="Working-with-patches-for-package.py-files-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-patches-for-package.py-files" title="Permalink"></a></h3><p>When working with Spack, it sometimes happens that we find problems in upstream <code>package.py</code> files. When this happens, we open pull requests to <a href="https://github.com/spack/spack-packages"><code>spack-packages</code></a> to fix the issue. However, having those pull requests merged can take weeks. To ensure that our continuous integration works, we manually apply those PR as part setting Spack up in our runners (the <code>setup-runner</code> workflow).</p><p>If you are working with Spack and <em>Palace</em> locally, you might need to apply the same patches. To apply a patch in <code>spack_repo/patches</code>:</p><pre><code class="language-bash hljs">cd $(spack location --repo builtin)
git apply /path/to/palace/spack_repo/patches/prNUM.diff</code></pre><p>Note that if you do so, your <code>builtin</code> repository will no longer be clean and you will not be able to update <code>spack-packages</code> as easily.</p><p>Instead, if you some patches applied and need to upgrade the recipes, the easiest way is probably to remove all the patches and re-apply the ones you need:</p><pre><code class="language-bash hljs">cd $(spack location --repo builtin)
git fetch
git reset --hard origin/develop
# Apply relevant patches</code></pre><p>It is often the case that patches are required for uncommon build configurations, so you might not need all of them.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../testing/">« Testing</a><a class="docs-footer-nextpage" href="../tutorial_add_new_unit_test/">Tutorial: Adding a New Unit Test »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.17.0 on <span class="colophon-date" title="Friday 27 February 2026 19:24">Friday 27 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
