<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX · Palace</title><meta name="title" content="Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX · Palace"/><meta property="og:title" content="Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX · Palace"/><meta property="twitter:title" content="Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX · Palace"/><meta name="description" content="Documentation for Palace."/><meta property="og:description" content="Documentation for Palace."/><meta property="twitter:description" content="Documentation for Palace."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img class="docs-light-only" src="../../assets/logo.png" alt="Palace logo"/><img class="docs-dark-only" src="../../assets/logo-dark.png" alt="Palace logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../quick/">Quick Start</a></li><li><a class="tocitem" href="../../install/">Installation</a></li><li><a class="tocitem" href="../../run/">Running <em>Palace</em></a></li><li><span class="tocitem">User Guide</span><ul><li><a class="tocitem" href="../../guide/guide/">Overview</a></li><li><a class="tocitem" href="../../guide/problem/">Problem Types</a></li><li><a class="tocitem" href="../../guide/model/">Simulation Models</a></li><li><a class="tocitem" href="../../guide/boundaries/">Boundary Conditions</a></li><li><a class="tocitem" href="../../guide/postprocessing/">Postprocessing and Visualization</a></li><li><a class="tocitem" href="../../guide/parallelism/">Parallelism and GPU Support</a></li></ul></li><li><span class="tocitem">Configuration File</span><ul><li><a class="tocitem" href="../../config/config/">Overview</a></li><li><a class="tocitem" href="../../config/problem/"><code>config[&quot;Problem&quot;]</code></a></li><li><a class="tocitem" href="../../config/model/"><code>config[&quot;Model&quot;]</code></a></li><li><a class="tocitem" href="../../config/domains/"><code>config[&quot;Domains&quot;]</code></a></li><li><a class="tocitem" href="../../config/boundaries/"><code>config[&quot;Boundaries&quot;]</code></a></li><li><a class="tocitem" href="../../config/solver/"><code>config[&quot;Solver&quot;]</code></a></li></ul></li><li><span class="tocitem">Features</span><ul><li><a class="tocitem" href="../../features/farfield/">Extracting Fields in the Radiation Zone</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Overview</a></li><li><a class="tocitem" href="../../examples/spheres/">Capacitance Matrix for Two Spheres</a></li><li><a class="tocitem" href="../../examples/rings/">Inductance Matrix for a Pair of Concentric Rings</a></li><li><a class="tocitem" href="../../examples/antenna/">Dipole Antenna and Radiation Fields</a></li><li><a class="tocitem" href="../../examples/cylinder/">Eigenmodes of a Cylinder</a></li><li><a class="tocitem" href="../../examples/coaxial/">Signal Propagation in a Coaxial Cable</a></li><li><a class="tocitem" href="../../examples/cpw/">Crosstalk Between Coplanar Waveguides</a></li></ul></li><li><span class="tocitem">For Developers</span><ul><li><a class="tocitem" href="../notes/">Developer Notes</a></li><li><a class="tocitem" href="../testing/">Testing</a></li><li><a class="tocitem" href="../tutorial_add_new_unit_test/">Tutorial: Adding a New Unit Test</a></li><li class="is-active"><a class="tocitem" href>Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX</a><ul class="internal"><li><a class="tocitem" href="#Basic-Profiling"><span>Basic Profiling</span></a></li><li><a class="tocitem" href="#Adding-NVTX-Ranges"><span>Adding NVTX Ranges</span></a></li><li><a class="tocitem" href="#Key-Takeaways"><span>Key Takeaways</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">For Developers</a></li><li class="is-active"><a href>Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/awslabs/palace" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/awslabs/palace/blob/main/docs/src/developer/tutorial_gpu_profiling.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><!--- Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved. --->
<!--- SPDX-License-Identifier: Apache-2.0 ---><h1 id="Tutorial:-GPU-Profiling-with-NVIDIA-Nsight-Systems-and-NVTX"><a class="docs-heading-anchor" href="#Tutorial:-GPU-Profiling-with-NVIDIA-Nsight-Systems-and-NVTX">Tutorial: GPU Profiling with NVIDIA Nsight Systems and NVTX</a><a id="Tutorial:-GPU-Profiling-with-NVIDIA-Nsight-Systems-and-NVTX-1"></a><a class="docs-heading-anchor-permalink" href="#Tutorial:-GPU-Profiling-with-NVIDIA-Nsight-Systems-and-NVTX" title="Permalink"></a></h1><p>This tutorial demonstrates how to profile <em>Palace</em> GPU execution using NVIDIA Nsight Systems with NVTX ranges for better code traceability.</p><p>NVIDIA Nsight Systems is a system-wide performance analysis tool that provides timeline profiling of CPU and GPU activity, including CUDA kernels, memory transfers, and API calls. NVIDIA Nsight Compute is a kernel-level profiler for detailed analysis of individual CUDA kernels. NVTX (NVIDIA Tools Extension) provides a C-based API for annotating events and ranges in your application, making profiles much easier to interpret.</p><p>GPU profiling is more complex than CPU profiling because GPU execution is asynchronous. GPU kernels launch asynchronously, so CPU timers don&#39;t capture actual GPU execution time. Performance depends heavily on memory access patterns and how well threads utilize GPU resources.</p><p>This tutorial assumes familiarity with compiling and running unit tests (see <a href="../testing/#Running-unit-tests">Running unit tests</a>). You&#39;ll need <em>Palace</em> compiled with CUDA support (<code>-DPALACE_WITH_CUDA=yes</code>) and NVIDIA Nsight Systems installed.</p><h2 id="Basic-Profiling"><a class="docs-heading-anchor" href="#Basic-Profiling">Basic Profiling</a><a id="Basic-Profiling-1"></a><a class="docs-heading-anchor-permalink" href="#Basic-Profiling" title="Permalink"></a></h2><p>In this tutorial, we will profile the <code>Vector Sum - Complex</code> unit test.</p><p>First, let us make the test more interesting for profiling by increasing the vector size. Find the <code>Vector Sum - Complex</code> test in <code>test/unit/test-vector.cpp</code>, and increase the size of the vector:</p><pre><code class="language-diff hljs">-ComplexVector cv(2);
+ComplexVector cv(20000);</code></pre><p>Make sure that we have a working and compiled version of <em>Palace</em>:</p><pre><code class="language-sh hljs">cmake -DPALACE_MFEM_USE_EXCEPTIONS=yes -DPALACE_WITH_CUDA=yes ..
make -j $(nproc)
palace-build/test/unit/unit-tests &quot;Vector Sum - Complex&quot; --device gpu --backend /gpu/cuda/magma</code></pre><p>This will show something along the lines of</p><pre><code class="nohighlight hljs">Device configuration: cuda,cpu
Memory configuration: host-umpire,cuda-umpire
Use GPU-aware MPI:    no
libCEED backend: /gpu/cuda/magma
Filters: &quot;Vector Sum - Complex&quot; [GPU] [Serial]
Randomness seeded to: 2674903133
===============================================================================
All tests passed (2 assertions in 1 test case)</code></pre><p>Now, run this under <code>nsys</code>:</p><pre><code class="language-sh hljs">nsys profile --trace=cuda,cublas --force-overwrite=true -o myprofile.nsys-rep \
  palace-build/test/unit/unit-tests &quot;Vector Sum - Complex&quot; --device gpu --backend /gpu/cuda/magma</code></pre><p>You can open the report with <code>nsys-ui myprofile.nsys-rep</code>. You should be greeted with a window like this:</p><br/><p align="center">
  <img src="../../assets/profiling/nsys2.png" alt="NVIDIA Nsight Systems timeline" style="max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" />
  <br/><em>Click image to view full size - NVIDIA Nsight Systems timeline</em>
</p><br/><p>There&#39;s a lot to unpack here. What you are looking at is the timeline of execution of the test as seen by different components. We have the CPUs on top, the GPU on the second row, and other components below. Consult the documentation to learn more about how to read this.</p><p>The key problem here is that this timeline has no clear connection to the source code. How do we know what is really happening?</p><p>We can get some clues by moving the mouse around and zooming. In particular, we can zoom into the region around 200 milliseconds. Here, we can see that there are some CUDA memory operations (under CUDA APIs), and we can see that there&#39;s some activity on the GPU (the little bars in the CUDA HW line). We can possibly guess that this is where the test is allocating the vectors and doing the sum operations.</p><br/><p align="center">
  <img src="../../assets/profiling/nsys2.png" alt="NVIDIA Nsight Systems zoomed view around 200ms showing CUDA memory operations" style="max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" />
  <br/><em>Click image to view full size - Zoomed view showing CUDA memory operations around 200ms</em>
</p><br/><h2 id="Adding-NVTX-Ranges"><a class="docs-heading-anchor" href="#Adding-NVTX-Ranges">Adding NVTX Ranges</a><a id="Adding-NVTX-Ranges-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-NVTX-Ranges" title="Permalink"></a></h2><p>With a little bit more effort, we could probably get insight directly from this report. However, it is often more convenient to use <a href="https://nvidia.github.io/NVTX/">NVTX ranges</a> to orient ourselves around the code. NVTX provides a way to mark the source code and see the markings in the Nsight report.</p><p>The most common NVTX marking is the <em>range</em>. As the name suggests, a range is a way to identify a block of code and give it a name.</p><p>To use NVTX, we need to include its header:</p><pre><code class="language-cpp hljs">#include &quot;nvtx3/nvtx3.hpp&quot;</code></pre><p>Then, we can define ranges with:</p><pre><code class="language-cpp hljs">nvtxRangePush(&quot;My first range&quot;);
mycode1();
mycode2();
mycode3();
nvtxRangePop();</code></pre><p>Alternatively, NVTX3 provides <code>nvtx3::scoped_range</code> which uses <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII</a> to automatically define a range in a given scope. The example above would become:</p><pre><code class="language-cpp hljs">{
    nvtx3::scoped_range range(&quot;My first range&quot;);
    mycode1();
    mycode2();
    mycode3();
}</code></pre><p>The advantage of this approach is that it&#39;s easy to forget to close the range manually, and RAII does it automatically when the scope ends. Consult to <a href="https://nvidia.github.io/NVTX/doxygen-cpp/">NVTX documentation</a> for more details.</p><p>Let us follow this method and change the test to:</p><pre><code class="language-cpp hljs">{
    nvtx3::scoped_range range(&quot;Initialize&quot;);
    mfem::forall(cv.Size(),
               [=] MFEM_HOST_DEVICE(int i)
               {
                 // Rank 0: [(0, 1), (0, 2), ...], Rank 1: [(1, 2), (1, 3), ...], etc.
                 d_real[i] = rank;
                 d_imag[i] = rank + i;
               });
}

std::complex&lt;double&gt; sum;
{
    nvtx3::scoped_range range(&quot;Sum&quot;);
    sum = linalg::Sum(Mpi::World(), cv);
}</code></pre><p>We recompile <em>Palace</em> and run the profiler again. When we have ranges, we need to ask <code>nsys</code> to keep track of them, so the invocation changes slightly. We also add other useful components to track:</p><pre><code class="language-sh hljs">nsys profile --trace=nvtx,cuda,cublas,mpi --nvtx-capture=range \
  --force-overwrite=true -o myprofile.nsys-rep \
  palace-build/test/unit/unit-tests &quot;Vector Sum - Complex&quot; --device gpu --backend /gpu/cuda/magma</code></pre><p>Now, if we open the new profile, we will see some differences:</p><br/><p align="center">
  <img src="../../assets/profiling/nsys3.png" alt="NVIDIA Nsight Systems with NVTX ranges showing MPI initialization and custom ranges" style="max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" />
  <br/><em>Click image to view full size - Timeline with NVTX ranges and MPI initialization visible</em>
</p><br/><p>First, we now learn that the large idle block was due to MPI initialization. Second, we see that there&#39;s now a new NVTX line. If we zoom in where it has activity, we find our <code>Initialize</code> and <code>Sum</code> blocks:</p><br/><p align="center">
  <img src="../../assets/profiling/nsys4.png" alt="NVIDIA Nsight Systems zoomed view of Initialize and Sum NVTX blocks" style="max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" />
  <br/><em>Click image to view full size - Detailed view of Initialize and Sum NVTX ranges</em>
</p><br/><p>We can now right-click on the <code>Initialize</code> block and select &quot;Fit to screen&quot;, then expand some sections to learn more about what is happening:</p><br/><p align="center">
  <img src="../../assets/profiling/nsys5.png" alt="NVIDIA Nsight Systems detailed view of Initialize block showing CUDA APIs and GPU kernel execution" style="max-width: 100%; cursor: pointer;" onclick="window.open(this.src, '_blank')" />
  <br/><em>Click image to view full size - Expanded view showing CUDA APIs and GPU kernel timing details</em>
</p><br/><p>What we see is that <code>Initialize</code> takes 200 microseconds, but most of it is due to one-time costs (as we see under CUDA APIs). The actual kernel that runs on the GPU is highlighted and takes less than 2 microseconds.</p><p>Something worth noting is that the actual kernel executed on the GPU starts only after the CPU has completed (the <code>CuKernel1D</code> block). This demonstrates why CPU timers cannot accurately profile GPU code unless they force synchronization (i.e., make the CPU wait for the GPU kernel to complete).</p><h2 id="Key-Takeaways"><a class="docs-heading-anchor" href="#Key-Takeaways">Key Takeaways</a><a id="Key-Takeaways-1"></a><a class="docs-heading-anchor-permalink" href="#Key-Takeaways" title="Permalink"></a></h2><p>NVTX ranges provide essential context for understanding GPU profiles by connecting timeline events to source code. The asynchronous nature of GPU execution means that CPU and GPU work can overlap, making traditional CPU timing inadequate for GPU performance analysis. From here, you should be equipped to start exploring Nsight System on your own.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../tutorial_add_new_unit_test/">« Tutorial: Adding a New Unit Test</a><a class="docs-footer-nextpage" href="../../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Thursday 30 October 2025 20:46">Thursday 30 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
